stages:
  - build

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2

docker-build:
  stage: build
  image: alpine:latest
  timeout: 30m
  variables:
    DOCKER_BUILDKIT: "0"
    COMPOSE_DOCKER_CLI_BUILD: "0"
  before_script:
    - apk add --no-cache curl bash
    - |
      DOCKER_VERSION="24.0.10"
      if ! curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-${DOCKER_VERSION}.tgz" | tar -xz -C /tmp 2>/dev/null; then
        DOCKER_VERSION="25.0.0"
        curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-${DOCKER_VERSION}.tgz" | tar -xz -C /tmp
      fi
    - mv /tmp/docker/docker /usr/local/bin/docker
    - chmod +x /usr/local/bin/docker
    - docker version
    - docker info
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        TAG="latest"
      else
        TAG="$CI_COMMIT_REF_NAME"
      fi
    - docker pull "$CI_REGISTRY_IMAGE:buildcache" || true
    - docker build --cache-from "$CI_REGISTRY_IMAGE:buildcache" -t "$CI_REGISTRY_IMAGE:$TAG" -t "$CI_REGISTRY_IMAGE:buildcache" .
    - docker push "$CI_REGISTRY_IMAGE:$TAG"
    - docker push "$CI_REGISTRY_IMAGE:buildcache" || true
  tags:
    - docker
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
