stages:
  - build

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: "tcp://docker:2375"

docker-build:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
      alias: docker
  timeout: 30m
  variables:
    DOCKER_BUILDKIT: "1"
  before_script:
    - echo "Waiting for Docker daemon..."
    - until docker info > /dev/null 2>&1; do echo "Docker daemon not ready, waiting..."; sleep 1; done
    - echo "Docker daemon is ready"
    - docker info
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - |
      if [ "$CI_COMMIT_BRANCH" = "$CI_DEFAULT_BRANCH" ]; then
        TAG="latest"
      else
        TAG="$CI_COMMIT_REF_NAME"
      fi
    - docker pull "$CI_REGISTRY_IMAGE:buildcache" || true
    - docker build --cache-from "$CI_REGISTRY_IMAGE:buildcache" -t "$CI_REGISTRY_IMAGE:$TAG" -t "$CI_REGISTRY_IMAGE:buildcache" .
    - docker push "$CI_REGISTRY_IMAGE:$TAG"
    - docker push "$CI_REGISTRY_IMAGE:buildcache" || true
  tags:
    - docker
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
